/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package in.ac.dei.mhrd.omr;

import javax.servlet.http.HttpServletRequest;

import java.io.File;
import java.sql.*;
import java.util.ArrayList;

import in.ac.dei.mhrd.omr.img.Connect;
import in.ac.dei.mhrd.omr.img.RotateImg;

import javax.servlet.http.HttpServletResponse;
import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

/** 
 * MyEclipse Struts
 * Creation date: 01-01-2011
 * 
 * XDoclet definition:
 * @struts.action path="/displayResponse" name="resultForm123" input="/SectionDetail.jsp" scope="request" validate="true"
 */
public class DisplayResponseAction extends Action {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		ResultForm resultForm123 = (ResultForm) form;// TODO Auto-generated method stub
		ResultSet rsResponse=null;
		ResultSet rsCorrectResponse=null;
		  
		  String qry;
		  int testid = 0;
		  String fileName=null; 
		    int rollno=0;
		    int row=0;
		    int i=0;
		    byte [] responseAnswer;
		    byte [] correctAnswer;
		    ArrayList<String> resAns=new ArrayList<String>();
		    ArrayList<String> corrAns=new ArrayList<String>();
		    ArrayList<Integer> corrQues=new ArrayList<Integer>();
		    ArrayList<Integer> responseQues=new ArrayList<Integer>();
		   
		    Connection con=null;
		    testid = Integer.parseInt(request.getParameter("testid"));
		    System.out.println("testid"+testid);
		    request.setAttribute("testid", testid);
		    fileName=request.getParameter("filename");
		    System.out.println("file name "+fileName);
		    request.setAttribute("filename", fileName);
		    File sheetName = new File(fileName);						
		    //file name to be extracted from previous page
			RotateImg ri=new RotateImg();
		    
		    //selecting roll no. corresponding to file name
		    try{
		    	System.out.println("in try");
		    	con=Connect.prepareConnection();
		    qry="select RollNo from response where TestId="+testid+" AND FileName='"+sheetName.getName()+"'";
		      PreparedStatement ps = con.prepareStatement(qry);
		       rsResponse=ps.executeQuery();
		       rsResponse.next();      
		       rollno=rsResponse.getInt("RollNo");
		       System.out.println("Roll No"+rollno);
		       request.setAttribute("rollNo", rollno);
		     
		       ps=con.prepareStatement("select Ques_no,answer from correctans where TestId=? order by Ques_no");
		       ps.setInt(1, testid);
		       rsCorrectResponse=ps.executeQuery();
		       rsCorrectResponse.last();
		       row=rsCorrectResponse.getRow();
		       rsCorrectResponse.beforeFirst();
		       correctAnswer=new byte[row];
		       while(rsCorrectResponse.next())
	  			  	 {
					correctAnswer[i]=(byte)rsCorrectResponse.getByte("answer");
					corrQues.add(rsCorrectResponse.getInt("Ques_no"));
					i++;
					}
		    
		       i=0;
		   	corrAns=ri.convertToString(correctAnswer);
			request.setAttribute("corrAns", corrAns);
			request.setAttribute("questionNo", corrQues);
				rsCorrectResponse=null;
				ps=con.prepareStatement("select ques_no,ans from response where TestId=? and FileName=? order by Ques_no");
				ps.setInt(1, testid);
				ps.setString(2, sheetName.getName());
				rsCorrectResponse=ps.executeQuery();
				rsCorrectResponse.last();
				row=rsCorrectResponse.getRow();
				responseAnswer=new byte[row];
				rsCorrectResponse.beforeFirst();
					while(rsCorrectResponse.next())
					{
						responseAnswer[i]=(byte)rsCorrectResponse.getByte("ans");
						responseQues.add(rsCorrectResponse.getInt("ques_no"));
						i++;
					}
					resAns=ri.convertToString(responseAnswer);
					request.setAttribute("resQues", responseQues);
					request.setAttribute("responseAns",resAns);
					i=0;
						}catch (Exception e) {
		    	System.out.println("Exception in display response action"+e.getMessage());
				// TODO: handle exception
			}
		return mapping.findForward("response");
	}
}