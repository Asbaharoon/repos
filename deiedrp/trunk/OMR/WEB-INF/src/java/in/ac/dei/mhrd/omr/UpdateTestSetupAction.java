/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package in.ac.dei.mhrd.omr;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import org.apache.log4j.Logger;
import org.apache.log4j.PropertyConfigurator;
import org.apache.log4j.xml.DOMConfigurator;

import in.ac.dei.mhrd.omr.ManageForm;
import java.sql.*;
import in.ac.dei.mhrd.omr.img.*;

/** 
 * MyEclipse Struts
 * Creation date: 11-25-2010
 * @author Anshul Agarwal
 * XDoclet definition:
 * @struts.action path="/updateTestSetup" name="manageForm" input="/manageTest.jsp" scope="request" validate="true"
 * 
 * This class fetches the updated test Detail and 
 * updates the testheader table, testsectionDetail table and wrongQuestion table   
 * 
 */
public class UpdateTestSetupAction extends Action {
	/*
	 * Generated Methods
	 */
	private static Logger log = Logger.getLogger(UpdateTestSetupAction.class);


	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		/*
		 * This function updates the testheader table, testsectiondetail table and wrongQuestion table
		 * 
		 */
		
		ManageForm manageForm = (ManageForm) form;
		HttpSession session = request.getSession(true);
		
			int i=1;
			/** Total Sections before updating the test  **/
			int tempSection;
			
			int temp;
			Connection con=null;
			ResultSet rsTestHeader=null;
			ResultSet rsWrongQues=null;
			PreparedStatement ps=null;
			int testNo=manageForm.getTestNo();
			int testId=(Integer)session.getAttribute("testId");
			int totalQuestion=manageForm.getTotalQuestion();
			int totalSection=manageForm.getTotalSection();
			/** Test conduct date                 **/
			Date date=manageForm.getDate();
			String qryTestHeader;
			String qryTestSecDetail;
			float negMarks;
			int questionNo;
			float marksEachQuestion;
		    int checkUpdate=0;
			try{
				con=Connect.prepareConnection();
				con.setAutoCommit(false);
				ps=con.prepareStatement("select Total_section from testheader where TestId=?");
				ps.setInt(1,testId);		
				rsTestHeader=ps.executeQuery();
				rsTestHeader.next();
					tempSection=rsTestHeader.getInt("Total_section");
					temp=tempSection;
					rsTestHeader.close();
					
			// Checking for wrong Question		
				ps=con.prepareStatement("select * from wrongquestion where TestId=?");
				ps.setInt(1, testId);
				rsWrongQues=ps.executeQuery();
				
				/*
				 * Delete wrong Question number that exceeds total questions
				 */
					if(rsWrongQues.next())
					{
						ps=con.prepareStatement("delete from wrongquestion where TestId=? and WrongQuestionNo>?");
						ps.setInt(1, testId);
						ps.setInt(2, totalQuestion);
						checkUpdate= ps.executeUpdate();
					}
				if(checkUpdate>=1){
					log.info("extra wrong Ques deleted");
				}
					//inserting rows as selected
					if(totalSection>tempSection)
						{
						ps=con.prepareStatement("insert into testsectiondetail(TestId,Section_number,No_of_question,Neg_Marks,Marks_each_question) values(?,?,?,?,?)");
						for(i=1;i<=(totalSection-tempSection);i++)
							{
								temp++;
								questionNo=Integer.parseInt(request.getParameter("noq"+temp));
								marksEachQuestion=Float.parseFloat(request.getParameter("meq"+temp));
								negMarks=Float.parseFloat(request.getParameter("nm"+temp));
								
								ps.setInt(1, testId);
								ps.setInt(2, temp);
								ps.setInt(3, questionNo);
								ps.setFloat(4, negMarks);
								ps.setFloat(5,marksEachQuestion);
								ps.addBatch();
							}
						int insertSecDetail[] = ps.executeBatch();
						System.out.println("insertSecDetail : " + insertSecDetail.length);
						}
					
					//deleting rows as selected
						else if(totalSection<tempSection)
						{
							ps=con.prepareStatement("delete from testsectiondetail where Section_number=? and TestId=?");
							for(i=1;i<=(tempSection-totalSection);i++)
							{
								
								
								ps.setInt(1,temp);
								ps.setInt(2, testId);
								ps.addBatch();
								temp--;
							}
							tempSection=temp;
							int delTestSec[] = ps.executeBatch();
							System.out.println("del Section : " + delTestSec.length);
						}
				
					qryTestHeader="update testheader set TestNo=?,Conduct_date=?,Total_section=?,Total_question=? where TestId=?";
					ps=con.prepareStatement(qryTestHeader);
					ps.setInt(1,testNo );
					ps.setDate(2,date);
					ps.setInt(3, totalSection);
					ps.setInt(4,totalQuestion);
					ps.setInt(5, testId);
					int countTestHeader=ps.executeUpdate();
				    System.out.println("count header :" + countTestHeader);
				i=1;
				qryTestSecDetail="update testsectiondetail set No_of_question=?,Marks_each_question=?,Neg_Marks=? where TestId=? and Section_number=?";
				ps=con.prepareStatement(qryTestSecDetail);
				//updating rest of the rows
				while(i<=tempSection)
					{	
						questionNo=Integer.parseInt(request.getParameter("noq"+i));
						marksEachQuestion=Float.parseFloat(request.getParameter("meq"+i));
						negMarks=Math.abs(Float.parseFloat(request.getParameter("nm"+i)));
						
						ps.setInt(1, questionNo);
						ps.setFloat(2, marksEachQuestion);
						ps.setFloat(3, negMarks);
						ps.setInt(4, testId);
						ps.setInt(5, i);
						ps.addBatch();
						i++;
					}
				
				int countSecDetail[] = ps.executeBatch();
				System.out.println("SEction Detail : " + countSecDetail.length);
				if(countSecDetail.length>=1){
					log.info("Test Updated Successfully!!");
					request.setAttribute("updateMsg", "Test Updated Sucessfully");
				}
					con.commit();
					con.close();
			}catch(Exception e)
			{
				log.error("Error in updating the TEST " +e);
				request.setAttribute("updateMsg", "Test cannot be Updated Sucessfully");

				System.out.println("updateTestSetUp Action Exception:"+e.getMessage());
			}
		return mapping.findForward("success");
	}
}