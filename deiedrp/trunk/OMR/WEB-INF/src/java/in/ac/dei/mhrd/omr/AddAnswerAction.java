/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package in.ac.dei.mhrd.omr;

import java.util.*;
import java.sql.*;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import in.ac.dei.mhrd.omr.img.*;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

/** 
 * MyEclipse Struts
 * Creation date: 12-30-2010
 * 
 * XDoclet definition:
 * @struts.action input="/ValidateAnswer.jsp" validate="true"
 */
public class AddAnswerAction extends Action {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		AnswerForm answerForm=(AnswerForm)form;
		int totalSection; 
		//total no. of sections 
		  
		int questionTotal;
		//total no. of questions
		
		 HttpSession hs = request.getSession(true);
		 ArrayList<Integer> quesNo=new ArrayList<Integer>((ArrayList<Integer>)hs.getAttribute("qno")); 
          		//ArrayList for Question no. 
         
         ArrayList<Integer> sectionNo=new ArrayList<Integer>((ArrayList<Integer>)hs.getAttribute("secno")); 
          		//ArrayList for the section no. 
         
        ArrayList<Byte> byteAnsValues=new ArrayList<Byte>((ArrayList<Byte>)hs.getAttribute("byteTransffer")); 
               //for getting the ArrayList of byte for questions from Validate answer page		 
 		 
 		 int testid = (Integer)hs.getAttribute("testid");
 		 PreparedStatement ps=null;  
 		 ResultSet rsCorrectAnswer=null; 
 		 int k=1; 
 		 int count=1; 
 		 int i=1; 
 		 questionTotal=1; 
 		Object elementQuestion,elementAnswer;
 			 
 		try{   
    			 Connection con = Connect.prepareConnection(); 
    			 con.setAutoCommit(false);
 			    ps=con.prepareStatement("select Total_section from testheader where TestId=?"); 
 			    ps.setInt(1, testid);
 			    rsCorrectAnswer=ps.executeQuery(); 
 			 	rsCorrectAnswer.next(); 
 			  	totalSection=rsCorrectAnswer.getInt("Total_section"); 
         
        	 
        	//updating correct answer  
        	 ps = con.prepareStatement("insert into correctans(TestId, SectionNumber, Ques_no, Answer) values (?,?,?,?)"); 
        	
        	while(i<=totalSection) 
        		{ 
               	 elementQuestion=quesNo.get(i-1);
               	  System.out.println(elementQuestion);
        	 for(k=1;k<=elementQuestion.hashCode();k++) 
        	{ 
        	elementAnswer=byteAnsValues.get(k-1);
        	System.out.println(elementAnswer);
            ps.setInt(1, testid); 
            ps.setInt(2, i); 
            ps.setInt(3,questionTotal); 
            ps.setInt(4,elementAnswer.hashCode()); 
             
            ps.addBatch(); 
            	 
              			questionTotal++; 
              			} 
              	i++; 
        		} 
        		int c[] = ps.executeBatch();
        	 if(c.length>=1) 
              { 
              System.out.println("Correct Answer inserted Successfully!! " + c.length); 
              request.setAttribute("wrongmsg","Correct Answer inserted Successfully!! " + c.length +" Questions");
              } 
              con.commit();
              con.close();
        	} 
        	 catch(Exception e) 
        	 { 
        	 System.out.println("Exception:"+e.getMessage()); 
        	 } 
 	
		return mapping.findForward("correctAnsMsg");
	}
}