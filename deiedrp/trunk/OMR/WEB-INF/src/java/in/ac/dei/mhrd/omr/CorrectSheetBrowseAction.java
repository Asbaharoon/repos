/*

 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package in.ac.dei.mhrd.omr;
import java.io.File;
import java.io.FileOutputStream;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.ArrayList;

import in.ac.dei.mhrd.omr.img.*;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.upload.FormFile;
import org.apache.struts.validator.Resources;

import com.mysql.jdbc.Connection;

/** 
 * MyEclipse Struts
 * Creation date: 09-29-2010
 * @author Anshul
 * XDoclet definition:
 * @struts.action path="/correctBrowse" name="correctSheetBrowse" input="/correctAnsBrowse" validate="true"
 * This class defines the method that uploads the scanned correct answer sheet,
 * reads the data from the sheet and finally deletes the sheet
 */
public class CorrectSheetBrowseAction extends Action {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		CorrectSheetBrowseForm correctSheetBrowse = (CorrectSheetBrowseForm) form;// TODO Auto-generated method stub
		System.out.println("inside action");
		
		
		
		int testid = SelectTestId.getTestId(correctSheetBrowse.getTest());
		//System.out.println("testid : " + testid);
		 byte[] correctAns;
		 ArrayList<String> ansList;
		 //System.out.println("comming here in action file");
		 FormFile correctSheet = correctSheetBrowse.getCorrectPath();
		 String fileName = correctSheet.getFileName();
		 File fileToCreate=null;
		 try {
		 
		
		 if(!((fileName.endsWith((".bmp"))||(fileName.endsWith(".BMP")))))
		   {
			  request.setAttribute("correctSheetMsg", "Please upload bitmap image");
			  
		   }
		 else{
			 byte[] fileData = correctSheet.getFileData();
		File fol = new File(getServlet().getServletContext().getRealPath("/"),"correct");
		fol.mkdir();
		String filePath = getServlet().getServletContext().getRealPath("/") + "correct";
		
		if(!fileName.equals("")){
			System.out.println("Servr Path : " + filePath);
		     
		     fileToCreate = new File(filePath, fileName);
		   // System.out.println("create c'tor : " + fileToCreate.exists());
		    if(!fileToCreate.exists()){
		    //	System.out.println("file ");
		    	FileOutputStream fo = new FileOutputStream(fileToCreate);
		    	//System.out.println("2"); 
		    	fo.write(correctSheet.getFileData());
		    //	System.out.println("writing data to file : ");
		    	/*System.out.println("file path : " + fileToCreate.getAbsolutePath());
		    	System.out.println("file goin to b deleted. ");
*/		    	fo.flush();

		    	fo.close();
		    }
		}
			// System.out.println("entering else"); 
			 
			 request.setAttribute("correctSheetMsg", " ");
		
             Connection con = (Connection) Connect.prepareConnection();
          
            PreparedStatement ps = con.prepareStatement(
                    "select  Total_question from testheader where TestId = ?");
             ps.setInt(1, testid);
            ResultSet rs = ps.executeQuery();
                          rs.next();
                          String str = filePath+"\\"+fileName;
                         // System.out.println("str : " + str);
        RotateImg correctImg = new RotateImg();
        correctAns=correctImg.processCorrectSheet(str,testid, (rs.getInt(1)));
       // System.out.println("ANSHUL ");
		ansList=correctImg.convertToString(correctAns);
		
		request.setAttribute("confirmAnsList", ansList);
		//System.out.println("testid in correct ans " + testid);
		request.setAttribute("correctAnsId", testid);
		request.setAttribute("path", filePath);
		request.setAttribute("Ques",rs.getString(1));
		fileToCreate.delete();
		 }
		 }
        catch(Exception e){
        	System.out.println("error in try " + e);
        }
		
	
		return mapping.findForward("confirmAns1");
		 
		
	}
}