/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package in.ac.dei.edrp.pms.changePassword;



import in.ac.dei.edrp.pms.adminConfig.ReadPropertiesFile;
import in.ac.dei.edrp.pms.dataBaseConnection.MyDataSource;
import in.ac.dei.edrp.pms.myMail.SendingMail;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import java.sql.*;
/** 
 * MyEclipse Struts
 * Creation date: 20-Aug-2010
 * 
 * 
 */
public class UserRePasswordAction extends Action {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		UserPasswordForm userpasswordform = (UserPasswordForm) form;// TODO Auto-generated method stub
		Connection con=null;
		request.setAttribute("passinfo","User password has not been changed.");
		try{
			con=MyDataSource.getConnection();
				PreparedStatement ps=con.prepareStatement("update login set password=SHA1(?) where login_user_id=?");
				ps.setString(1, userpasswordform.getRepassworduser().toLowerCase());
				ps.setString(2, userpasswordform.getUserid());
				
				int x=ps.executeUpdate();
				if(x>0)
				{
				String url="http://"+request.getServerName()+":"+request.getServerPort()+request.getContextPath();
				String s4="Welcome to Project Management System," +
					"\n Your password has been changed successfully.\n " +
					"click on the following link," +url+
					" and proceed by your login.\n" +
					" User Id: "+userpasswordform.getUserid().trim()+
					"\n New Password: "+userpasswordform.getRepassworduser().toLowerCase()+
					"\n Thanks !";
			boolean	bool=SendingMail.sendMail(s4,userpasswordform.getUserid().trim(),
						ReadPropertiesFile.mailConfig(getServlet().getServletContext().getRealPath("/")+"WEB-INF/"));

				if(bool)
					request.setAttribute("passinfo","User password has been changed successfully! and" +
							" new password has been send to the user email-id");
				else
					request.setAttribute("passinfo","User password has been changed successfully! but" +
					" mail has not been send");
				}
			
		}catch(Exception e){
			//System.out.println("Exception is coming in user repasswordAction.java="+e);
			}
		finally
		{
			MyDataSource.freeConnection(con);
		}
		return mapping.findForward("passinfo");
	
	}
}