/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package in.ac.dei.edrp.pms.changePassword;



import in.ac.dei.edrp.pms.adminConfig.ReadPropertiesFile;
import in.ac.dei.edrp.pms.dataBaseConnection.MyDataSource;
import in.ac.dei.edrp.pms.myMail.SendingMail;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import java.sql.*;
import java.util.Locale;
import java.util.ResourceBundle;
/** 
 * MyEclipse Struts
 * Creation date: 20-Aug-2010
 * 
 * 
 */
public class UserRePasswordAction extends Action {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		UserPasswordForm userpasswordform = (UserPasswordForm) form;// TODO Auto-generated method stub
		Connection con=null;
		request.setAttribute("passinfo","User password has not been changed.");
		try{
			con=MyDataSource.getConnection();
				PreparedStatement ps=con.prepareStatement("update login set password=SHA1(?) where login_user_id=?");
				ps.setString(1, userpasswordform.getRepassworduser().toLowerCase());
				ps.setString(2, userpasswordform.getUserid());
				
				int x=ps.executeUpdate();
				if(x>0)
				{
					Locale locale = new Locale("en", "US");
					ResourceBundle message = ResourceBundle.getBundle("in//ac//dei//edrp//pms//propertiesFile//ApplicationResources",locale);

				String url="http://"+request.getServerName()+":"+request.getServerPort()+request.getContextPath();
				String s4=message.getString("body.text.mail.changePassword") + " "+url+
				"\n"+message.getString("label.user")+": "+userpasswordform.getUserid()+
				"\n"+message.getString("label.newPassword")+": "+userpasswordform.getRepassworduser().toLowerCase()+
				"\n "+message.getString("body.text.mail.note")+
				"\n "+message.getString("body.text.mail.thanks");
			boolean	bool=SendingMail.sendMail(s4,userpasswordform.getUserid().trim(),
						message.getString("mail.subject.changepassword.user"),
						ReadPropertiesFile.mailConfig(getServlet().getServletContext().getRealPath("/")+"WEB-INF/"));

				if(bool)
					request.setAttribute("passinfo","User password has been changed successfully! and" +
							" new password has been send to the user email-id");
				else
					request.setAttribute("passinfo","User password has been changed successfully! but" +
					" mail has not been send");
				}
			
		}catch(Exception e){
			//System.out.println("Exception is coming in user repasswordAction.java="+e);
			}
		finally
		{
			MyDataSource.freeConnection(con);
		}
		return mapping.findForward("passinfo");
	
	}
}
